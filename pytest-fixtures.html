<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Pytest fixtures with tear down</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Ramblings of an autodidact... Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Ramblings of an autodidact...</a></h1>
                <nav><ul>
                    <li><a href="/pages/about.html">About</a></li>
                    <li><a href="/category/cryptography.html">Cryptography</a></li>
                    <li><a href="/category/datascience.html">DataScience</a></li>
                    <li><a href="/category/general.html">General</a></li>
                    <li class="active"><a href="/category/pytest.html">Pytest</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/pytest-fixtures.html" rel="bookmark"
           title="Permalink to Pytest fixtures with tear down">Pytest fixtures with tear down</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2020-02-19T17:40:00-06:00">
                Published: Wed 19 February 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/martin-uribe.html">Martin Uribe</a>
        </address>
<p>In <a href="/category/pytest.html">Pytest</a>.</p>

</footer><!-- /.post-info -->      <h1>Pytest fixtures with tear down code</h1>
<p>Today after listening to <a href="https://twitter.com/brianokken">Brian Okken's</a> <a href="https://testandcode.com/">Test &amp; Code</a> podcast with <a href="https://twitter.com/anthonypjshaw">Anthony Shaw</a>, I was reminded that I wanted to install Anthon's <a href="https://github.com/tonybaloney/pycharm-security">Python Security Plugin</a> for <a href="https://www.jetbrains.com/pycharm/">JetBrain's PyCharm</a> IDE. That was a breeze to install and it just worked out of the box. I fired it up and it automatically checked my code and called it good.</p>
<p>I then started to write some tests and while checking a password, it alerted me to an issue. It made a suggestion to fix it, so I accepted and it updated my code and even added the proper import statement!</p>
<p>FROM:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">assert</span> <span class="n">dummy</span><span class="o">.</span><span class="n">password</span> <span class="o">==</span> <span class="s2">&quot;admin&quot;</span>
</code></pre></div>


<p>TO:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">secrets</span> <span class="kn">import</span> <span class="n">compare_digest</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">passlock.entry</span> <span class="kn">import</span> <span class="n">Entry</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dummy</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Entry</span><span class="p">(</span><span class="s2">&quot;router&quot;</span><span class="p">,</span> <span class="s2">&quot;http://192.168.2.1&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_entry</span><span class="p">(</span><span class="n">dummy</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">dummy</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;router&quot;</span>
    <span class="k">assert</span> <span class="n">dummy</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="s2">&quot;http://192.168.2.1&quot;</span>
    <span class="k">assert</span> <span class="n">dummy</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;admin&quot;</span>
    <span class="k">assert</span> <span class="n">compare_digest</span><span class="p">(</span><span class="n">dummy</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">)</span>
</code></pre></div>


<p>Although, this is just a dummy password for testing, it doesn't hurt to build up some good habits!</p>
<h2>On to the fixture tear down</h2>
<p>This is when I got to the part where I had to test the creation of my private and public keys. Since I was creating them for testing and didn't want them around afterwards, I decided that I needed to make them go away after the tests were done.</p>
<p>I was already using fixtures so that I didn't have to recreate the instances of my classes for each test; generating the keys take a bit of time! I went crazy an opted to make them future proof with <strong>4096-bits</strong>...</p>
<p>The challenge was figuring out how to tear them down. I did some initial searches and was coming up blank. I found <a href="https://pythontesting.net/framework/pytest/pytest-fixtures-easy-example/">Brian's blog</a> about the topic, but his examples just didn't cut it. All they demonstrated was how to print a message, it didn't actually show how to return and instance, and then have it torn down afterwards.</p>
<p>Brian's example:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">resource_a_setup</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">resources_a_setup()&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">resource_a_teardown</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">resources_a_teardown()&#39;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">resource_a_teardown</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_1_that_needs_resource_a</span><span class="p">(</span><span class="n">resource_a_setup</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;test_1_that_needs_resource_a()&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_2_that_does_not</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">test_2_that_does_not()&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_3_that_does</span><span class="p">(</span><span class="n">resource_a_setup</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">test_3_that_does()&#39;</span><span class="p">)</span>
</code></pre></div>


<p>I ended up reading the actual <a href="https://docs.pytest.org/en/latest/fixture.html">pytest documentation</a>, who would have thunk?! I'll do you guys a solid and cut out the noise and show you what I did:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">custom_locker</span><span class="p">():</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">Vault</span><span class="p">(</span><span class="s2">&quot;.toe&quot;</span><span class="p">,</span> <span class="s2">&quot;tlock&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">v</span>
    <span class="n">v</span><span class="o">.</span><span class="n">plock</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">v</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">v</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">rmdir</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_vault_custom</span><span class="p">(</span><span class="n">custom_locker</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">custom_locker</span><span class="o">.</span><span class="n">loc</span> <span class="o">==</span> <span class="s2">&quot;.toe&quot;</span>
    <span class="k">assert</span> <span class="n">custom_locker</span><span class="o">.</span><span class="n">key_name</span> <span class="o">==</span> <span class="s2">&quot;tlock&quot;</span>
</code></pre></div>


<p>Setting the <code>scope</code> of the fixture to <em>module</em> makes it so that it doesn't actually do the tearing down until after all of the tests are completed. Perfect!</p>
<p>The variables in the <code>Vault</code> instance are Path objects, so it was simple enough to just <code>unlink()</code> the files and then <code>rmdir()</code> the directory after it's been emptied. Of course, I tried removing the directory first, but it wasn't having any of that until it was empty...</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://github.com/clamytoe">github</a></li>
                            <li><a href="https://codechalleng.es/profiles/clamytoe">pybit.es</a></li>
                            <li><a href="https://pybit.es/author/martin-uribe.html">articles</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://www.linkedin.com/in/martin-uribe/">linkedin</a></li>
                            <li><a href="https://twitter.com/clamytoe">twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>